name: Deploy Production

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment:
      name: production
      url: ${{ secrets.PROD_URL }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install
        run: npm ci

      - name: Typecheck
        run: npm run check

      - name: Lint
        run: npm run lint

      - name: Unit tests
        run: npm test

      - name: Build
        run: npm run build

      - name: Deploy Supabase (migrations + functions)
        if: ${{ secrets.SUPABASE_ACCESS_TOKEN != '' && secrets.SUPABASE_PROJECT_REF != '' }}
        uses: supabase/setup-cli@v1
        with:
          version: latest
      - name: Supabase link
        if: ${{ secrets.SUPABASE_ACCESS_TOKEN != '' && secrets.SUPABASE_PROJECT_REF != '' }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
      - name: Supabase db push
        if: ${{ secrets.SUPABASE_ACCESS_TOKEN != '' && secrets.SUPABASE_PROJECT_REF != '' && secrets.SUPABASE_DB_PASSWORD != '' }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: supabase db push --db-password ${{ secrets.SUPABASE_DB_PASSWORD }}
      - name: Supabase functions deploy
        if: ${{ secrets.SUPABASE_ACCESS_TOKEN != '' && secrets.SUPABASE_PROJECT_REF != '' }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          supabase functions deploy stripe-webhook --no-verify-jwt --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
          supabase functions deploy contractor-apply --no-verify-jwt --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
          supabase functions deploy tenant-create-setup-intent --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
          supabase functions deploy tenant-finalize-setup-intent --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
          supabase functions deploy admin-charge-now --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
          supabase functions deploy autopay-run-daily --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}

      - name: Deploy Vercel (production)
        if: ${{ secrets.VERCEL_TOKEN != '' && secrets.VERCEL_ORG_ID != '' && secrets.VERCEL_PROJECT_ID != '' }}
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: --prod

      - name: Post-deploy smoke tests
        if: ${{ secrets.PROD_URL != '' }}
        env:
          PROD_URL: ${{ secrets.PROD_URL }}
        run: node - <<'NODE'
          const assert = (cond, msg) => { if (!cond) { throw new Error(msg); } };
          const base = String(process.env.PROD_URL || '').replace(/\/+$/, '');
          assert(base.startsWith('http'), 'PROD_URL must be a full URL, e.g. https://ihs.management');

          const paths = ['/', '/servicios', '/como-trabajamos', '/finanzas', '/honorarios', '/propiedades', '/contacto'];

          const check = async (path) => {
            const url = `${base}${path}`;
            const res = await fetch(url, { redirect: 'follow' });
            const text = await res.text();
            assert(res.ok, `GET ${url} failed: ${res.status}`);
            assert(text.toLowerCase().includes('<!doctype html') || text.toLowerCase().includes('<html'), `GET ${url} did not return HTML`);
          };

          await Promise.all(paths.map(check));
          console.log('Smoke tests OK:', paths.join(', '));
        NODE
